<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 22px;
        }
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }
        .info-item {
            margin: 8px 0;
        }
        .label {
            font-weight: bold;
            color: #333;
            display: inline-block;
            width: 120px;
        }
        .value {
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
        }
        .success {
            background: #d1edff;
            color: #004085;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="avatar">üë§</div>
        <h1>Telegram Profile</h1>
        <div id="status" class="status loading">
            –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É...
        </div>
        <div id="userInfo"></div>
        <div id="debugInfo" style="display: none; margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px; text-align: left;"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è NocoDB
        const NOCODB_CONFIG = {
            BASE_URL: 'https://app.nocodb.com',
            API_TOKEN: 'EB8ueGhiFFEsnbjkn9wKg8WUfBE73XWPgXMuB6uH',
            TABLE_ID: 'mqo292nskad9hpm'
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        function debugLog(message) {
            console.log(message);
            const debugEl = document.getElementById('debugInfo');
            if (debugEl) {
                debugEl.innerHTML += message + '<br>';
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Telegram WebApp
        function detectTelegramWebApp() {
            debugLog('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã...');
            
            // –°–ø–æ—Å–æ–± 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Telegram
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                debugLog('‚úÖ –ù–∞–π–¥–µ–Ω window.Telegram.WebApp');
                return true;
            }
            
            // –°–ø–æ—Å–æ–± 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –æ–∫–Ω–µ
            if (window.parent && typeof window.parent.Telegram !== 'undefined' && window.parent.Telegram.WebApp) {
                debugLog('‚úÖ –ù–∞–π–¥–µ–Ω window.parent.Telegram.WebApp');
                return true;
            }
            
            // –°–ø–æ—Å–æ–± 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ User Agent
            if (navigator.userAgent.includes('Telegram')) {
                debugLog('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω Telegram –≤ User Agent');
                return true;
            }
            
            // –°–ø–æ—Å–æ–± 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è GitHub Pages)
            const urlParams = new URLSearchParams(window.location.search);
            const tgWebAppData = urlParams.get('tgWebAppData');
            const tgWebAppStartParam = urlParams.get('tgWebAppStartParam');
            
            if (tgWebAppData || tgWebAppStartParam) {
                debugLog('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã Telegram –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL');
                return true;
            }
            
            // –°–ø–æ—Å–æ–± 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ hash –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            if (window.location.hash.includes('tgWebApp')) {
                debugLog('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω Telegram hash –≤ URL');
                return true;
            }
            
            debugLog('‚ùå Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            return false;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        function getUserDataFromURL() {
            debugLog('üì° –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const tgWebAppData = urlParams.get('tgWebAppData');
            
            if (tgWebAppData) {
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                    const decodedData = decodeURIComponent(tgWebAppData);
                    const parsedData = JSON.parse(decodedData);
                    debugLog('üìä –î–∞–Ω–Ω—ã–µ –∏–∑ URL: ' + JSON.stringify(parsedData));
                    return parsedData.user || null;
                } catch (e) {
                    debugLog('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
                }
            }
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ hash
            if (window.location.hash) {
                try {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hashData = hashParams.get('tgWebAppData');
                    if (hashData) {
                        const decodedData = decodeURIComponent(hashData);
                        const parsedData = JSON.parse(decodedData);
                        return parsedData.user || null;
                    }
                } catch (e) {
                    debugLog('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ hash: ' + e.message);
                }
            }
            
            return null;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp API
        function getUserDataFromTelegramAPI() {
            debugLog('üì° –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram API...');
            
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    
                    const user = Telegram.WebApp.initDataUnsafe?.user;
                    debugLog('üìä –î–∞–Ω–Ω—ã–µ –∏–∑ Telegram API: ' + JSON.stringify(user));
                    return user;
                } catch (e) {
                    debugLog('‚ùå –û—à–∏–±–∫–∞ Telegram API: ' + e.message);
                }
            }
            
            return null;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ NocoDB
        async function saveUserToNocoDB(userData) {
            try {
                debugLog('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É...');
                
                const response = await fetch(
                    `${NOCODB_CONFIG.BASE_URL}/api/v2/tables/${NOCODB_CONFIG.TABLE_ID}/records`,
                    {
                        method: 'POST',
                        headers: {
                            'xc-token': NOCODB_CONFIG.API_TOKEN,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id_tg: userData.id,
                            name: userData.first_name + (userData.last_name ? ' ' + userData.last_name : ''),
                            username: userData.username || ''
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                debugLog('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ' + JSON.stringify(result));
                return result;
            } catch (error) {
                debugLog('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
                throw error;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function checkUserExists(userId) {
            try {
                debugLog('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const response = await fetch(
                    `${NOCODB_CONFIG.BASE_URL}/api/v2/tables/${NOCODB_CONFIG.TABLE_ID}/records?where=(id_tg,eq,${userId})`,
                    {
                        headers: {
                            'xc-token': NOCODB_CONFIG.API_TOKEN
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const exists = data.list && data.list.length > 0;
                debugLog(exists ? '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' : '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return exists;
            } catch (error) {
                debugLog('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
                return false;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function displayUserInfo(userData, isNewUser = false) {
            const userInfoElement = document.getElementById('userInfo');
            const statusElement = document.getElementById('status');
            
            userInfoElement.innerHTML = `
                <div class="user-info">
                    <div class="info-item">
                        <span class="label">ID:</span>
                        <span class="value">${userData.id}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">–ò–º—è:</span>
                        <span class="value">${userData.first_name} ${userData.last_name || ''}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Username:</span>
                        <span class="value">${userData.username ? '@' + userData.username : '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                    </div>
                </div>
            `;
            
            statusElement.textContent = isNewUser ? '‚úÖ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!' : '‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!';
            statusElement.className = 'status success';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('debugInfo').style.display = 'block';
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function initApp() {
            debugLog('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            const isTelegram = detectTelegramWebApp();
            
            if (isTelegram) {
                debugLog('üì± –û–±–Ω–∞—Ä—É–∂–µ–Ω Telegram Mini App');
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
                let userData = getUserDataFromTelegramAPI();
                
                if (!userData) {
                    userData = getUserDataFromURL();
                }
                
                if (userData) {
                    debugLog('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userExists = await checkUserExists(userData.id);
                    
                    if (!userExists) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await saveUserToNocoDB(userData);
                        displayUserInfo(userData, true);
                    } else {
                        displayUserInfo(userData, false);
                    }
                } else {
                    document.getElementById('status').textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    document.getElementById('status').className = 'status error';
                    document.getElementById('debugInfo').style.display = 'block';
                }
            } else {
                debugLog('üåê –û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä');
                document.getElementById('status').textContent = 'üì± –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞';
                document.getElementById('status').className = 'status error';
                document.getElementById('userInfo').innerHTML = `
                    <p style="color: #666; margin: 15px 0;">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram Mini App</p>
                    <button class="btn" onclick="testConnection()">–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ</button>
                `;
                document.getElementById('debugInfo').style.display = 'block';
            }
        }

        // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ
        async function testConnection() {
            try {
                const response = await fetch(
                    `${NOCODB_CONFIG.BASE_URL}/api/v2/tables/${NOCODB_CONFIG.TABLE_ID}/records?limit=1`,
                    {
                        headers: {
                            'xc-token': NOCODB_CONFIG.API_TOKEN
                        }
                    }
                );
                
                if (response.ok) {
                    alert('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initApp);

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ Telegram API –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–∑–∂–µ)
        setTimeout(() => {
            if (detectTelegramWebApp() && !document.querySelector('.user-info')) {
                debugLog('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
                initApp();
            }
        }, 2000);
    </script>
</body>
</html>
