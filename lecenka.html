
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лестница - StarGame</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #0f0c29;
            color: white;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(46, 17, 81, 0.7);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .balance-container {
            display: flex;
            gap: 10px;
        }
        
        .balance {
            background: rgba(123, 44, 191, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .bonus-balance {
            background: rgba(0, 180, 219, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .game-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .title {
            text-align: center;
            margin: 20px 0 30px;
            font-size: 24px;
            color: #f7f7f7;
        }
        
        .game-area {
            background: linear-gradient(135deg, #1a0a2e 0%, #3a0ca3 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(123, 44, 191, 0.5);
            margin-bottom: 20px;
        }
        
        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .bet-amount {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bet-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(123, 44, 191, 0.5);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        
        .bet-buttons {
            display: flex;
            gap: 10px;
        }
        
        .bet-btn {
            flex: 1;
            background: rgba(123, 44, 191, 0.3);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bet-btn:hover {
            background: rgba(123, 44, 191, 0.5);
        }
        
        .bet-btn.active {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
        }
        
        .action-btn {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 44, 191, 0.4);
        }
        
        .action-btn.disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
        }
        
        .ladder {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            margin: 20px 0;
        }
        
        .floor {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(123, 44, 191, 0.2);
            border-radius: 8px;
        }
        
        .floor-number {
            font-weight: bold;
            width: 30px;
            text-align: center;
        }
        
        .slots {
            display: flex;
            gap: 5px;
            flex: 1;
        }
        
        .slot {
            flex: 1;
            height: 40px;
            background: rgba(123, 44, 191, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .slot.selected {
            background: rgba(46, 125, 50, 0.5);
            border: 2px solid #2e7d32;
        }
        
        .slot.collapsed {
            background: rgba(211, 47, 47, 0.5);
            border: 2px solid #d32f2f;
        }
        
        .slot.safe {
            background: rgba(100, 100, 100, 0.3);
            border: 1px solid #555;
        }
        
        .multiplier-info {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }
        
        .current-multiplier {
            font-weight: bold;
            color: #00b4db;
        }
        
        .game-result {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .win {
            color: #4caf50;
        }
        
        .lose {
            color: #f44336;
        }
        
        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a0a2e 0%, #3a0ca3 100%);
            padding: 25px;
            border-radius: 16px;
            width: 95%;
            max-width: 400px;
            text-align: center;
            position: relative;
            border: 2px solid #7b2cbf;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .modal-text {
            margin: 15px 0;
            font-size: 14px;
            color: #b8b8b8;
        }
        
        .ok-btn {
            background: #7b2cbf;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .ok-btn:hover {
            background: #5a189a;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #b8b8b8;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" id="back-btn">← Назад</button>
        <div class="balance-container">
            <div class="balance" id="user-balance">0 ⭐</div>
            <div class="bonus-balance" id="user-bonus-balance">0 ⭐</div>
        </div>
    </div>
    
    <div class="game-container">
        <h1 class="title">Лестница</h1>
        
        <div id="loading" class="loading">
            Загрузка данных...
        </div>
        
        <div id="content" style="display: none;">
            <div class="game-area">
                <div class="bet-controls">
                    <div class="bet-amount">
                        <input type="number" id="bet-amount" class="bet-input" placeholder="Сумма ставки" min="10" value="10">
                    </div>
                    <div class="bet-buttons">
                        <button class="bet-btn" data-amount="10">10</button>
                        <button class="bet-btn" data-amount="50">50</button>
                        <button class="bet-btn" data-amount="100">100</button>
                        <button class="bet-btn" data-amount="500">500</button>
                    </div>
                </div>
                
                <div class="ladder" id="ladder">
                    <!-- Лестница будет генерироваться динамически -->
                </div>
                
                <div class="multiplier-info">
                    Текущий множитель: <span class="current-multiplier" id="current-multiplier">1.0x</span>
                </div>
                
                <div class="game-result" id="game-result"></div>
                
                <button class="action-btn" id="start-btn">Начать игру</button>
                <button class="action-btn disabled" id="cashout-btn" style="display: none;">Забрать выигрыш</button>
                <button class="action-btn" id="next-floor-btn" style="display: none;">Идти дальше</button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно результата -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="result-title">Результат игры</div>
            <div class="modal-text" id="result-text"></div>
            <div class="modal-text" id="bonus-info" style="display: none;">Вы играли за бонусный баланс</div>
            <button class="ok-btn" id="ok-btn">Хорошо</button>
        </div>
    </div>

    <script>
        // Инициализация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.appspot.com",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUserId = null;
        let currentBalance = 0;
        let currentBonusBalance = 0;
        let currentBet = 10;
        let isBonusGame = false;
        let gameState = 'idle'; // 'idle', 'playing', 'completed'
        let currentFloor = 0;
        let selectedSlot = -1;
        let multiplier = 1.0;
        const floorsCount = 6;
        const slotsPerFloor = 5;
        const multipliers = [1.0, 1.5, 2.0, 3.0, 5.0, 8.0, 15.0];
        
        function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('user_id');
            
            if (!userId) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; user_id=`);
                if (parts.length === 2) userId = parts.pop().split(';').shift();
            }
            
            if (!userId) {
                console.error("User ID not found in URL or cookies");
                return null;
            }
            
            return userId;
        }
        
        async function loadUserData(userId) {
            return new Promise((resolve, reject) => {
                try {
                    const userRef = database.ref('users/' + userId);
                    
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            currentBalance = userData.balance || 0;
                            currentBonusBalance = userData.bonus_balance || 0;
                            document.getElementById('user-balance').textContent = `${currentBalance} ⭐`;
                            document.getElementById('user-bonus-balance').textContent = `${currentBonusBalance} ⭐`;
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('content').style.display = 'block';
                            resolve(userData);
                        } else {
                            const error = new Error("Пользователь не найден");
                            document.getElementById('loading').textContent = error.message;
                            reject(error);
                        }
                    }, (error) => {
                        console.error("Ошибка чтения данных:", error);
                        document.getElementById('loading').textContent = 'Ошибка загрузки данных';
                        reject(error);
                    });
                    
                } catch (error) {
                    console.error('Ошибка загрузки данных:', error);
                    document.getElementById('loading').textContent = 'Ошибка: ' + error.message;
                    reject(error);
                }
            });
        }
        
        function createLadder() {
            const ladder = document.getElementById('ladder');
            ladder.innerHTML = '';
            
            for (let i = 0; i < floorsCount; i++) {
                const floor = document.createElement('div');
                floor.className = 'floor';
                floor.dataset.floor = i;
                
                const floorNumber = document.createElement('div');
                floorNumber.className = 'floor-number';
                floorNumber.textContent = i + 1;
                
                const slots = document.createElement('div');
                slots.className = 'slots';
                
                for (let j = 0; j < slotsPerFloor; j++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slot.dataset.slot = j;
                    slots.appendChild(slot);
                }
                
                floor.appendChild(floorNumber);
                floor.appendChild(slots);
                ladder.appendChild(floor);
            }
        }
        
        function updateButtons() {
            const betAmount = parseInt(document.getElementById('bet-amount').value) || 10;
            const canPlay = (isBonusGame && currentBonusBalance >= betAmount) || (!isBonusGame && currentBalance >= betAmount);
            
            document.getElementById('start-btn').classList.toggle('disabled', !canPlay || gameState !== 'idle');
            document.getElementById('cashout-btn').classList.toggle('disabled', gameState !== 'playing');
            document.getElementById('next-floor-btn').classList.toggle('disabled', gameState !== 'playing');
        }
        
        async function createTransaction(userId, type, amount, description = '', isBonus = false) {
            try {
                const userRef = database.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                let updates = {};
                
                if (type === 'deposit' || type === 'win') {
                    updates.balance = (userData.balance || 0) + amount;
                } else if (type === 'game_bet') {
                    if (isBonus) {
                        updates.bonus_balance = (userData.bonus_balance || 0) - amount;
                    } else {
                        updates.balance = (userData.balance || 0) - amount;
                    }
                }
                
                await userRef.update(updates);
                
                if (updates.balance !== undefined) {
                    currentBalance = updates.balance;
                    document.getElementById('user-balance').textContent = `${currentBalance} ⭐`;
                }
                if (updates.bonus_balance !== undefined) {
                    currentBonusBalance = updates.bonus_balance;
                    document.getElementById('user-bonus-balance').textContent = `${currentBonusBalance} ⭐`;
                }
                
                return { success: true };
            } catch (error) {
                console.error('Ошибка обновления баланса:', error);
                throw error;
            }
        }
        
        function startGame() {
            const betAmount = parseInt(document.getElementById('bet-amount').value) || 10;
            
            if (betAmount < 10) {
                alert('Минимальная ставка - 10 ⭐');
                return;
            }
            
            // Проверяем баланс
            isBonusGame = currentBonusBalance >= betAmount;
            const canPlay = (isBonusGame && currentBonusBalance >= betAmount) || (!isBonusGame && currentBalance >= betAmount);
            
            if (!canPlay) {
                alert('Недостаточно средств на балансе');
                return;
            }
            
            currentBet = betAmount;
            gameState = 'playing';
            currentFloor = 0;
            selectedSlot = -1;
            multiplier = 1.0;
            
            // Скрываем/показываем кнопки
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('cashout-btn').style.display = 'block';
            document.getElementById('next-floor-btn').style.display = 'block';
            
            // Обновляем множитель
            document.getElementById('current-multiplier').textContent = `${multiplier.toFixed(1)}x`;
            
            // Сбрасываем результат
            document.getElementById('game-result').style.display = 'none';
            
            // Сбрасываем лестницу
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('selected', 'collapsed', 'safe');
            });
            
            // Разрешаем выбор слота на первом этаже
            const firstFloorSlots = document.querySelectorAll('.floor[data-floor="0"] .slot');
            firstFloorSlots.forEach(slot => {
                slot.style.cursor = 'pointer';
                slot.onclick = () => selectSlot(0, parseInt(slot.dataset.slot));
            });
            
            // Снимаем деньги
            createTransaction(
                currentUserId, 
                'game_bet', 
                currentBet, 
                `Ставка в игре "Лестница"`,
                isBonusGame
            ).catch(error => {
                console.error('Ошибка при списании средств:', error);
                resetGame();
            });
        }
        
        function selectSlot(floor, slot) {
            if (gameState !== 'playing' || floor !== currentFloor) return;
            
            // Снимаем выделение со всех слотов на текущем этаже
            const currentFloorSlots = document.querySelectorAll(`.floor[data-floor="${floor}"] .slot`);
            currentFloorSlots.forEach(s => s.classList.remove('selected'));
            
            // Выделяем выбранный слот
            const selected = document.querySelector(`.floor[data-floor="${floor}"] .slot[data-slot="${slot}"]`);
            selected.classList.add('selected');
            selectedSlot = slot;
            
            // Запрещаем выбор других слотов
            currentFloorSlots.forEach(s => {
                s.style.cursor = 'default';
                s.onclick = null;
            });
            
            // Показываем кнопки действий
            document.getElementById('cashout-btn').style.display = 'block';
            document.getElementById('next-floor-btn').style.display = 'block';
        }
        
        function nextFloor() {
            if (gameState !== 'playing' || selectedSlot === -1) return;
            
            // Определяем какой слот разрушится (не может быть выбранным слотом)
            let collapsedSlot;
            do {
                collapsedSlot = Math.floor(Math.random() * slotsPerFloor);
            } while (collapsedSlot === selectedSlot);
            
            // Помечаем разрушенный слот
            const collapsed = document.querySelector(`.floor[data-floor="${currentFloor}"] .slot[data-slot="${collapsedSlot}"]`);
            collapsed.classList.add('collapsed');
            
            // Помечаем остальные слоты как безопасные
            const currentFloorSlots = document.querySelectorAll(`.floor[data-floor="${currentFloor}"] .slot`);
            currentFloorSlots.forEach(slot => {
                if (!slot.classList.contains('selected') && !slot.classList.contains('collapsed')) {
                    slot.classList.add('safe');
                }
            });
            
            // Проверяем, не разрушен ли выбранный слот (проигрыш)
            if (collapsedSlot === selectedSlot) {
                endGame(false);
                return;
            }
            
            // Переходим на следующий этаж
            currentFloor++;
            multiplier = multipliers[currentFloor];
            document.getElementById('current-multiplier').textContent = `${multiplier.toFixed(1)}x`;
            
            // Если это последний этаж - автоматически завершаем игру с выигрышем
            if (currentFloor >= floorsCount - 1) {
                endGame(true);
                return;
            }
            
            // Разрешаем выбор слота на следующем этаже
            const nextFloorSlots = document.querySelectorAll(`.floor[data-floor="${currentFloor}"] .slot`);
            nextFloorSlots.forEach(slot => {
                slot.style.cursor = 'pointer';
                slot.onclick = () => selectSlot(currentFloor, parseInt(slot.dataset.slot));
            });
            
            // Сбрасываем выбранный слот
            selectedSlot = -1;
            
            // Скрываем кнопки действий до выбора слота
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('next-floor-btn').style.display = 'none';
        }
        
        function cashout() {
            if (gameState !== 'playing' || selectedSlot === -1) return;
            
            endGame(true);
        }
        
        function endGame(isWin) {
            gameState = 'completed';
            
            // Помечаем все оставшиеся слоты как безопасные
            document.querySelectorAll('.slot').forEach(slot => {
                if (!slot.classList.contains('selected') && !slot.classList.contains('collapsed')) {
                    slot.classList.add('safe');
                }
            });
            
            // Вычисляем выигрыш
            const winAmount = isWin ? Math.floor(currentBet * multiplier) : 0;
            
            // Показываем результат
            const resultElement = document.getElementById('game-result');
            resultElement.style.display = 'block';
            
            if (isWin) {
                resultElement.textContent = `Поздравляем! Вы выиграли ${winAmount} ⭐ (x${multiplier.toFixed(1)})`;
                resultElement.className = 'game-result win';
                
                // Зачисляем выигрыш
                createTransaction(
                    currentUserId, 
                    'win', 
                    winAmount, 
                    `Выигрыш в игре "Лестница" (x${multiplier.toFixed(1)})${isBonusGame ? ' (бонусный баланс)' : ''}`
                );
            } else {
                resultElement.textContent = 'Вы проиграли. Попробуйте еще раз!';
                resultElement.className = 'game-result lose';
            }
            
            // Показываем кнопку "Новая игра"
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('start-btn').textContent = 'Новая игра';
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('next-floor-btn').style.display = 'none';
            
            // Обновляем доступность кнопок
            updateButtons();
        }
        
        function resetGame() {
            gameState = 'idle';
            currentFloor = 0;
            selectedSlot = -1;
            multiplier = 1.0;
            
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('start-btn').textContent = 'Начать игру';
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('next-floor-btn').style.display = 'none';
            
            document.getElementById('current-multiplier').textContent = '1.0x';
            document.getElementById('game-result').style.display = 'none';
            
            // Сбрасываем лестницу
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('selected', 'collapsed', 'safe');
                slot.style.cursor = 'default';
                slot.onclick = null;
            });
            
            updateButtons();
        }
        
        function setupEventListeners() {
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'index.html' + (currentUserId ? `?user_id=${currentUserId}` : '');
            });
            
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('cashout-btn').addEventListener('click', cashout);
            document.getElementById('next-floor-btn').addEventListener('click', nextFloor);
            
            document.getElementById('ok-btn').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
            });
            
            // Кнопки быстрой ставки
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const amount = parseInt(btn.dataset.amount);
                    document.getElementById('bet-amount').value = amount;
                    updateButtons();
                });
            });
            
            // Поле ввода ставки
            document.getElementById('bet-amount').addEventListener('input', () => {
                updateButtons();
            });
        }
        
        async function initApp() {
            currentUserId = getUserId();
            
            if (!currentUserId) {
                document.getElementById('loading').textContent = 'Ошибка: ID пользователя не найден. Пожалуйста, войдите через главную страницу.';
                document.getElementById('back-btn').style.display = 'block';
                return;
            }
            
            try {
                await loadUserData(currentUserId);
                createLadder();
                setupEventListeners();
                updateButtons();
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                document.getElementById('loading').textContent = 'Ошибка загрузки данных. Пожалуйста, попробуйте позже.';
                document.getElementById('back-btn').style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
