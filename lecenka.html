<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–µ—Å—Ç–Ω–∏—Ü–∞ - StarGame</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #0f0c29;
            color: white;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(46, 17, 81, 0.7);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .balance-container {
            display: flex;
            gap: 10px;
        }
        
        .balance {
            background: rgba(123, 44, 191, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .bonus-balance {
            background: rgba(0, 180, 219, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .game-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .title {
            text-align: center;
            margin: 20px 0 30px;
            font-size: 24px;
            color: #f7f7f7;
        }
        
        .game-area {
            background: linear-gradient(135deg, #1a0a2e 0%, #3a0ca3 100%);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(123, 44, 191, 0.5);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #b8b8b8;
        }
        
        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .bet-amount {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bet-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(123, 44, 191, 0.5);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        
        .bet-buttons {
            display: flex;
            gap: 10px;
        }
        
        .bet-btn {
            flex: 1;
            background: rgba(123, 44, 191, 0.3);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bet-btn:hover {
            background: rgba(123, 44, 191, 0.5);
        }
        
        .bet-btn.active {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
        }
        
        .stones-controls {
            margin-bottom: 20px;
        }
        
        .stone-buttons {
            display: flex;
            gap: 10px;
        }
        
        .stone-btn {
            flex: 1;
            background: rgba(123, 44, 191, 0.3);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .stone-btn:hover {
            background: rgba(123, 44, 191, 0.5);
        }
        
        .stone-btn.active {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
        }
        
        .action-btn {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 44, 191, 0.4);
        }
        
        .action-btn.disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
        }
        
        .ladder {
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            margin: 20px 0;
        }
        
        .floor {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(123, 44, 191, 0.2);
            border-radius: 8px;
        }
        
        .floor-number {
            font-weight: bold;
            width: 30px;
            text-align: center;
        }
        
        .slots {
            display: flex;
            gap: 5px;
            flex: 1;
        }
        
        .slot {
            flex: 1;
            height: 40px;
            background: rgba(123, 44, 191, 0.3);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .slot.selected {
            background: rgba(46, 125, 50, 0.5);
            border: 2px solid #2e7d32;
        }
        
        .slot.collapsed {
            background: rgba(211, 47, 47, 0.5);
            border: 2px solid #d32f2f;
        }
        
        .slot.safe {
            background: rgba(100, 100, 100, 0.3);
            border: 1px solid #555;
        }
        
        .multiplier-info {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }
        
        .current-multiplier {
            font-weight: bold;
            color: #00b4db;
        }
        
        .game-result {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .win {
            color: #4caf50;
        }
        
        .lose {
            color: #f44336;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a0a2e 0%, #3a0ca3 100%);
            padding: 25px;
            border-radius: 16px;
            width: 95%;
            max-width: 400px;
            text-align: center;
            position: relative;
            border: 2px solid #7b2cbf;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .modal-text {
            margin: 15px 0;
            font-size: 14px;
            color: #b8b8b8;
        }
        
        .ok-btn {
            background: #7b2cbf;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .ok-btn:hover {
            background: #5a189a;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #b8b8b8;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" id="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="balance-container">
            <div class="balance" id="user-balance">0 ‚≠ê</div>
            <div class="bonus-balance" id="user-bonus-balance">0 ‚≠ê</div>
        </div>
    </div>
    
    <div class="game-container">
        <h1 class="title">–õ–µ—Å—Ç–Ω–∏—Ü–∞</h1>
        
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div id="content" style="display: none;">
            <div class="game-area">
                <div class="section-title">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</div>
                <div class="bet-controls">
                    <div class="bet-amount">
                        <input type="number" id="bet-amount" class="bet-input" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏" min="10" value="10">
                    </div>
                    <div class="bet-buttons">
                        <button class="bet-btn" data-amount="10">10</button>
                        <button class="bet-btn" data-amount="50">50</button>
                        <button class="bet-btn" data-amount="100">100</button>
                        <button class="bet-btn" data-amount="500">500</button>
                    </div>
                </div>
                
                <div class="section-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–º–Ω–µ–π</div>
                <div class="stones-controls">
                    <div class="stone-buttons">
                        <button class="stone-btn active" data-stones="1">1 ü™®</button>
                        <button class="stone-btn" data-stones="2">2 ü™®</button>
                        <button class="stone-btn" data-stones="3">3 ü™®</button>
                        <button class="stone-btn" data-stones="4">4 ü™®</button>
                    </div>
                </div>
                
                <div class="ladder" id="ladder">
                    <!-- –õ–µ—Å—Ç–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <div class="multiplier-info">
                    –¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: <span class="current-multiplier" id="current-multiplier">1.0x</span>
                </div>
                
                <div class="game-result" id="game-result"></div>
                
                <button class="action-btn" id="play-btn">–ò–≥—Ä–∞—Ç—å</button>
                <button class="action-btn disabled" id="cashout-btn" style="display: none;">–ó–∞–±—Ä–∞—Ç—å ‚≠ê</button>
                <button class="action-btn" id="next-floor-btn" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–∂</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã</div>
            <div class="modal-text" id="result-text"></div>
            <div class="modal-text" id="bonus-info" style="display: none;">–í—ã –∏–≥—Ä–∞–ª–∏ –∑–∞ –±–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
            <button class="ok-btn" id="ok-btn">–•–æ—Ä–æ—à–æ</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.appspot.com",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUserId = null;
        let currentBalance = 0;
        let currentBonusBalance = 0;
        let currentBet = 10;
        let stonesCount = 1;
        let isBonusGame = false;
        let gameState = 'idle'; // 'idle', 'playing', 'completed'
        let currentFloor = 0;
        let selectedSlots = [];
        let multiplier = 1.0;
        const floorsCount = 6;
        const slotsPerFloor = 5;
        const multipliers = [1.0, 1.5, 2.0, 3.0, 5.0, 8.0, 15.0];
        
        function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('user_id');
            
            if (!userId) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; user_id=`);
                if (parts.length === 2) userId = parts.pop().split(';').shift();
            }
            
            if (!userId) {
                console.error("User ID not found in URL or cookies");
                return null;
            }
            
            return userId;
        }
        
        async function loadUserData(userId) {
            return new Promise((resolve, reject) => {
                try {
                    const userRef = database.ref('users/' + userId);
                    
                    userRef.on('value', (snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            currentBalance = userData.balance || 0;
                            currentBonusBalance = userData.bonus_balance || 0;
                            document.getElementById('user-balance').textContent = `${currentBalance} ‚≠ê`;
                            document.getElementById('user-bonus-balance').textContent = `${currentBonusBalance} ‚≠ê`;
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('content').style.display = 'block';
                            resolve(userData);
                        } else {
                            const error = new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                            document.getElementById('loading').textContent = error.message;
                            reject(error);
                        }
                    }, (error) => {
                        console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", error);
                        document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                        reject(error);
                    });
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
                    reject(error);
                }
            });
        }
        
        function createLadder() {
            const ladder = document.getElementById('ladder');
            ladder.innerHTML = '';
            
            for (let i = 0; i < floorsCount; i++) {
                const floor = document.createElement('div');
                floor.className = 'floor';
                floor.dataset.floor = i;
                
                const floorNumber = document.createElement('div');
                floorNumber.className = 'floor-number';
                floorNumber.textContent = i + 1;
                
                const slots = document.createElement('div');
                slots.className = 'slots';
                
                for (let j = 0; j < slotsPerFloor; j++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slot.dataset.slot = j;
                    slots.appendChild(slot);
                }
                
                floor.appendChild(floorNumber);
                floor.appendChild(slots);
                ladder.appendChild(floor);
            }
        }
        
        function updateButtons() {
            const betAmount = parseInt(document.getElementById('bet-amount').value) || 10;
            const canPlay = (isBonusGame && currentBonusBalance >= betAmount) || (!isBonusGame && currentBalance >= betAmount);
            
            document.getElementById('play-btn').classList.toggle('disabled', !canPlay || gameState !== 'idle');
            document.getElementById('cashout-btn').classList.toggle('disabled', gameState !== 'playing' || selectedSlots.length === 0);
            document.getElementById('next-floor-btn').classList.toggle('disabled', gameState !== 'playing' || selectedSlots.length === 0);
        }
        
        async function createTransaction(userId, type, amount, description = '', isBonus = false) {
            try {
                const userRef = database.ref('users/' + userId);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                let updates = {};
                
                if (type === 'deposit' || type === 'win') {
                    updates.balance = (userData.balance || 0) + amount;
                } else if (type === 'game_bet') {
                    if (isBonus) {
                        updates.bonus_balance = (userData.bonus_balance || 0) - amount;
                    } else {
                        updates.balance = (userData.balance || 0) - amount;
                    }
                }
                
                await userRef.update(updates);
                
                if (updates.balance !== undefined) {
                    currentBalance = updates.balance;
                    document.getElementById('user-balance').textContent = `${currentBalance} ‚≠ê`;
                }
                if (updates.bonus_balance !== undefined) {
                    currentBonusBalance = updates.bonus_balance;
                    document.getElementById('user-bonus-balance').textContent = `${currentBonusBalance} ‚≠ê`;
                }
                
                return { success: true };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', error);
                throw error;
            }
        }
        
        function startGame() {
            const betAmount = parseInt(document.getElementById('bet-amount').value) || 10;
            
            if (betAmount < 10) {
                showResultModal('–û—à–∏–±–∫–∞', '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ - 10 ‚≠ê');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
            isBonusGame = currentBonusBalance >= betAmount;
            const canPlay = (isBonusGame && currentBonusBalance >= betAmount) || (!isBonusGame && currentBalance >= betAmount);
            
            if (!canPlay) {
                showResultModal('–û—à–∏–±–∫–∞', '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ');
                return;
            }
            
            currentBet = betAmount;
            gameState = 'playing';
            currentFloor = 0;
            selectedSlots = [];
            multiplier = 1.0;
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('play-btn').style.display = 'none';
            document.getElementById('cashout-btn').style.display = 'flex';
            document.getElementById('next-floor-btn').style.display = 'flex';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å
            document.getElementById('current-multiplier').textContent = `${multiplier.toFixed(1)}x`;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            document.getElementById('game-result').style.display = 'none';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–µ—Å—Ç–Ω–∏—Ü—É
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('selected', 'collapsed', 'safe');
            });
            
            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–æ—Ç–æ–≤ –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–∂–µ
            const firstFloorSlots = document.querySelectorAll('.floor[data-floor="0"] .slot');
            firstFloorSlots.forEach(slot => {
                slot.style.cursor = 'pointer';
                slot.onclick = () => selectSlot(0, parseInt(slot.dataset.slot));
            });
            
            // –°–Ω–∏–º–∞–µ–º –¥–µ–Ω—å–≥–∏
            createTransaction(
                currentUserId, 
                'game_bet', 
                currentBet, 
                `–°—Ç–∞–≤–∫–∞ –≤ –∏–≥—Ä–µ "–õ–µ—Å—Ç–Ω–∏—Ü–∞"`,
                isBonusGame
            ).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤:', error);
                resetGame();
            });
        }
        
        function selectSlot(floor, slot) {
            if (gameState !== 'playing' || floor !== currentFloor) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –≤—ã–±—Ä–∞—Ç—å –µ—â–µ –∫–∞–º–Ω–∏
            const currentSelected = document.querySelectorAll(`.floor[data-floor="${floor}"] .slot.selected`).length;
            if (currentSelected >= stonesCount) {
                return;
            }
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ—Ç
            const selected = document.querySelector(`.floor[data-floor="${floor}"] .slot[data-slot="${slot}"]`);
            selected.classList.add('selected');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
            selectedSlots.push({ floor, slot });
            
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–∞–º–Ω–µ–π - —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è
            if (selectedSlots.length >= stonesCount) {
                // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—ã–±–æ—Ä –¥—Ä—É–≥–∏—Ö —Å–ª–æ—Ç–æ–≤
                const currentFloorSlots = document.querySelectorAll(`.floor[data-floor="${floor}"] .slot`);
                currentFloorSlots.forEach(s => {
                    s.style.cursor = 'default';
                    s.onclick = null;
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                document.getElementById('cashout-btn').classList.remove('disabled');
                document.getElementById('next-floor-btn').classList.remove('disabled');
            }
        }
        
        function nextFloor() {
            if (gameState !== 'playing' || selectedSlots.length === 0) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Å–ª–æ—Ç—ã —Ä–∞–∑—Ä—É—à–∞—Ç—Å—è (–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏)
            let collapsedSlots = [];
            const availableSlots = [];
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –Ω–∞ —Ç–µ–∫—É—â–µ–º —ç—Ç–∞–∂–µ
            for (let i = 0; i < slotsPerFloor; i++) {
                const isSelected = selectedSlots.some(s => s.floor === currentFloor && s.slot === i);
                if (!isSelected) {
                    availableSlots.push(i);
                }
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ—Ç—ã –¥–ª—è —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º 1)
            const slotsToCollapse = Math.min(availableSlots.length, Math.max(1, Math.floor(Math.random() * 3) + 1));
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            for (let i = availableSlots.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableSlots[i], availableSlots[j]] = [availableSlots[j], availableSlots[i]];
            }
            
            collapsedSlots = availableSlots.slice(0, slotsToCollapse);
            
            // –ü–æ–º–µ—á–∞–µ–º —Ä–∞–∑—Ä—É—à–µ–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
            collapsedSlots.forEach(slot => {
                const collapsed = document.querySelector(`.floor[data-floor="${currentFloor}"] .slot[data-slot="${slot}"]`);
                collapsed.classList.add('collapsed');
            });
            
            // –ü–æ–º–µ—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ—Ç—ã –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ
            const currentFloorSlots = document.querySelectorAll(`.floor[data-floor="${currentFloor}"] .slot`);
            currentFloorSlots.forEach(slot => {
                if (!slot.classList.contains('selected') && !slot.classList.contains('collapsed')) {
                    slot.classList.add('safe');
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–∞–∑—Ä—É—à–µ–Ω –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ª–æ—Ç (–ø—Ä–æ–∏–≥—Ä—ã—à)
            const anyCollapsed = selectedSlots.some(s => 
                s.floor === currentFloor && 
                collapsedSlots.includes(s.slot)
            );
            
            if (anyCollapsed) {
                endGame(false);
                return;
            }
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–∂
            currentFloor++;
            multiplier = multipliers[currentFloor];
            document.getElementById('current-multiplier').textContent = `${multiplier.toFixed(1)}x`;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É —Å –≤—ã–∏–≥—Ä—ã—à–µ–º
            if (currentFloor >= floorsCount - 1) {
                endGame(true);
                return;
            }
            
            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–æ—Ç–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–∂–µ
            const nextFloorSlots = document.querySelectorAll(`.floor[data-floor="${currentFloor}"] .slot`);
            nextFloorSlots.forEach(slot => {
                slot.style.cursor = 'pointer';
                slot.onclick = () => selectSlot(currentFloor, parseInt(slot.dataset.slot));
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç—ã
            selectedSlots = [];
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–æ –≤—ã–±–æ—Ä–∞ —Å–ª–æ—Ç–æ–≤
            document.getElementById('cashout-btn').classList.add('disabled');
            document.getElementById('next-floor-btn').classList.add('disabled');
        }
        
        function cashout() {
            if (gameState !== 'playing' || selectedSlots.length === 0) return;
            
            endGame(true);
        }
        
        function endGame(isWin) {
            gameState = 'completed';
            
            // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–ª–æ—Ç—ã –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ
            document.querySelectorAll('.slot').forEach(slot => {
                if (!slot.classList.contains('selected') && !slot.classList.contains('collapsed')) {
                    slot.classList.add('safe');
                }
            });
            
            // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
            const winAmount = isWin ? Math.floor(currentBet * multiplier) : 0;
            
            if (isWin) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤—ã–∏–≥—Ä—ã—à–µ–º
                showResultModal(
                    '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', 
                    `–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ ${currentFloor + 1} —ç—Ç–∞–∂–µ–π –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ ${winAmount} ‚≠ê (x${multiplier.toFixed(1)})`,
                    true
                );
                
                // –ó–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
                createTransaction(
                    currentUserId, 
                    'win', 
                    winAmount, 
                    `–í—ã–∏–≥—Ä—ã—à –≤ –∏–≥—Ä–µ "–õ–µ—Å—Ç–Ω–∏—Ü–∞" (x${multiplier.toFixed(1)})${isBonusGame ? ' (–±–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å)' : ''}`
                );
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–æ–∏–≥—Ä—ã—à–µ–º
                showResultModal(
                    '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 
                    '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!',
                    false
                );
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–≥—Ä–∞—Ç—å"
            document.getElementById('play-btn').style.display = 'flex';
            document.getElementById('play-btn').textContent = '–ò–≥—Ä–∞—Ç—å';
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('next-floor-btn').style.display = 'none';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
            updateButtons();
        }
        
        function showResultModal(title, text, isWin = false) {
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-text').textContent = text;
            
            if (isBonusGame) {
                document.getElementById('bonus-info').style.display = 'block';
            } else {
                document.getElementById('bonus-info').style.display = 'none';
            }
            
            document.getElementById('result-modal').style.display = 'flex';
        }
        
        function resetGame() {
            gameState = 'idle';
            currentFloor = 0;
            selectedSlots = [];
            multiplier = 1.0;
            
            document.getElementById('play-btn').style.display = 'flex';
            document.getElementById('play-btn').textContent = '–ò–≥—Ä–∞—Ç—å';
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('next-floor-btn').style.display = 'none';
            
            document.getElementById('current-multiplier').textContent = '1.0x';
            document.getElementById('game-result').style.display = 'none';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–µ—Å—Ç–Ω–∏—Ü—É
            document.querySelectorAll('.slot').forEach(slot => {
                slot.classList.remove('selected', 'collapsed', 'safe');
                slot.style.cursor = 'default';
                slot.onclick = null;
            });
            
            updateButtons();
        }
        
        function setupEventListeners() {
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = 'index.html' + (currentUserId ? `?user_id=${currentUserId}` : '');
            });
            
            document.getElementById('play-btn').addEventListener('click', startGame);
            document.getElementById('cashout-btn').addEventListener('click', cashout);
            document.getElementById('next-floor-btn').addEventListener('click', nextFloor);
            
            document.getElementById('ok-btn').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
                resetGame();
            });
            
            // –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–π —Å—Ç–∞–≤–∫–∏
            document.querySelectorAll('.bet-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const amount = parseInt(btn.dataset.amount);
                    document.getElementById('bet-amount').value = amount;
                    updateButtons();
                });
            });
            
            // –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ç–∞–≤–∫–∏
            document.getElementById('bet-amount').addEventListener('input', () => {
                updateButtons();
            });
            
            // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–º–Ω–µ–π
            document.querySelectorAll('.stone-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.stone-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    stonesCount = parseInt(btn.dataset.stones);
                });
            });
        }
        
        async function initApp() {
            currentUserId = getUserId();
            
            if (!currentUserId) {
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                document.getElementById('back-btn').style.display = 'block';
                return;
            }
            
            try {
                await loadUserData(currentUserId);
                createLadder();
                setupEventListeners();
                updateButtons();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
                document.getElementById('back-btn').style.display = 'block';
            }
        }
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
