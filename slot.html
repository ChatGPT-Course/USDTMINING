<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarGame - –ò–≥—Ä–∞ –≤ –°–ª–æ—Ç—ã</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #0f0c29;
            color: white;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }
        
        #particles {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            height: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .profile {
            background: rgba(46, 17, 81, 0.7);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-grow: 1;
        }
        
        .balance {
            background: rgba(123, 44, 191, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }
        
        .balance-item {
            flex: 1;
            text-align: center;
        }
        
        .balance-label {
            font-size: 12px;
            color: #d1d1d1;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 22px;
            font-weight: bold;
            color: #f7f7f7;
        }
        
        .slot-machine {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .slot-cell {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            background: rgba(123, 44, 191, 0.2);
            border-radius: 10px;
            border: 2px solid #7b2cbf;
            transition: all 0.3s;
        }
        
        .slot-cell.win {
            animation: pulse 0.5s infinite, glow 5s;
            border-color: #4caf50;
            box-shadow: 0 0 15px #4caf50;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 15px #4caf50; }
            100% { box-shadow: 0 0 15px #4caf50; }
        }
        
        .spin-btn {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .spin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 44, 191, 0.4);
        }
        
        .spin-btn:disabled {
            background: rgba(100, 100, 100, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .paytable {
            margin-top: 30px;
            width: 100%;
            background: rgba(46, 17, 81, 0.5);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(123, 44, 191, 0.3);
        }
        
        .paytable-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .paytable-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .paytable-combination {
            display: flex;
            align-items: center;
        }
        
        .paytable-emoji {
            font-size: 20px;
            margin: 0 3px;
        }
        
        .paytable-payout {
            font-weight: bold;
            color: #4caf50;
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: #b8b8b8;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(46, 17, 81, 0.9);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .modal-text {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .modal-btn-confirm {
            background: linear-gradient(135deg, #7b2cbf 0%, #3a0ca3 100%);
            color: white;
        }
        
        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
        }
        
        .result-modal {
            text-align: center;
        }
        
        .result-amount {
            font-size: 28px;
            font-weight: bold;
            color: #4caf50;
            margin: 15px 0;
        }
        
        .win-lines {
            margin: 15px 0;
            font-size: 16px;
            color: #d1d1d1;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        .floating {
            animation: float 6s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="particles"></div>
    <div class="container">
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div id="game-content" style="display: none;">
            <button class="back-btn" id="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
            
            <div class="profile">
                <div class="balance floating">
                    <div class="balance-item">
                        <div class="balance-label">–û—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="balance-amount" id="user-balance">0 ‚≠ê</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">–ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="balance-amount" id="user-bonus-balance">0 ‚≠ê</div>
                    </div>
                </div>
                
                <div class="slot-machine">
                    <div class="slots-grid" id="slots-grid">
                        <!-- 3x3 grid –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ JavaScript -->
                    </div>
                    
                    <button class="spin-btn" id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å (5 ‚≠ê)</button>
                </div>
                
                <div class="paytable">
                    <div class="paytable-title">–í—ã–∏–≥—Ä—ã—à–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏</div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üçí</span>
                            <span class="paytable-emoji">üçí</span>
                            <span class="paytable-emoji">üçí</span>
                        </div>
                        <div class="paytable-payout">x2 (10‚≠ê / 5‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üçã</span>
                            <span class="paytable-emoji">üçã</span>
                            <span class="paytable-emoji">üçã</span>
                        </div>
                        <div class="paytable-payout">x3 (15‚≠ê / 7‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üçä</span>
                            <span class="paytable-emoji">üçä</span>
                            <span class="paytable-emoji">üçä</span>
                        </div>
                        <div class="paytable-payout">x5 (25‚≠ê / 12‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üçá</span>
                            <span class="paytable-emoji">üçá</span>
                            <span class="paytable-emoji">üçá</span>
                        </div>
                        <div class="paytable-payout">x10 (50‚≠ê / 25‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üçâ</span>
                            <span class="paytable-emoji">üçâ</span>
                            <span class="paytable-emoji">üçâ</span>
                        </div>
                        <div class="paytable-payout">x20 (100‚≠ê / 50‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">‚≠ê</span>
                            <span class="paytable-emoji">‚≠ê</span>
                            <span class="paytable-emoji">‚≠ê</span>
                        </div>
                        <div class="paytable-payout">x50 (250‚≠ê / 125‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üí∞</span>
                            <span class="paytable-emoji">üí∞</span>
                            <span class="paytable-emoji">üí∞</span>
                        </div>
                        <div class="paytable-payout">x100 (500‚≠ê / 250‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">7Ô∏è‚É£</span>
                            <span class="paytable-emoji">7Ô∏è‚É£</span>
                            <span class="paytable-emoji">7Ô∏è‚É£</span>
                        </div>
                        <div class="paytable-payout">x200 (1000‚≠ê / 500‚≠ê)</div>
                    </div>
                    <div class="paytable-item">
                        <div class="paytable-combination">
                            <span class="paytable-emoji">üö´</span>
                            <span class="paytable-emoji">üö´</span>
                        </div>
                        <div class="paytable-payout">x0 (–∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç –≤—ã–∏–≥—Ä—ã—à)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏ -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏</div>
            <div class="modal-text" id="confirm-text">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É 5 ‚≠ê?
            </div>
            <div class="modal-text" id="bonus-warning" style="color: #ff9800; display: none;">
                –í–Ω–∏–º–∞–Ω–∏–µ: —Å—Ç–∞–≤–∫–∞ –¥–µ–ª–∞–µ—Ç—Å—è —Å –±–æ–Ω—É—Å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞!<br>
                –í—ã–∏–≥—Ä—ã—à –±—É–¥–µ—Ç –≤ 2 —Ä–∞–∑–∞ –º–µ–Ω—å—à–µ.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="cancel-spin">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-confirm" id="confirm-spin">–ö—Ä—É—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div id="result-modal" class="modal">
        <div class="modal-content result-modal">
            <div class="modal-title" id="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div class="modal-text" id="result-text"></div>
            <div class="result-amount" id="result-amount"></div>
            <div class="win-lines" id="win-lines"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" id="close-result">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMos6Y7C-krTLuKCI4VJG-TFLo6QI--k8",
            authDomain: "vrot-x-7a48f.firebaseapp.com",
            databaseURL: "https://vrot-x-7a48f-default-rtdb.firebaseio.com",
            projectId: "vrot-x-7a48f",
            storageBucket: "vrot-x-7a48f.appspot.com",
            messagingSenderId: "622297225288",
            appId: "1:622297225288:web:5df6a5b02ffddedd96e07d"
        };
        
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let currentUserId = null;
        let userBalance = 0;
        let userBonusBalance = 0;
        let isSpinning = false;
        let useBonusBalance = false;
        const BET_AMOUNT = 5;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–∏–≥—Ä—ã—à–∞ (0-100)
        const CHANCE_OF_WIN = 100; // 30% —à–∞–Ω—Å –Ω–∞ –≤—ã–∏–≥—Ä—ã—à –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        // –°–∏–º–≤–æ–ª—ã –¥–ª—è —Å–ª–æ—Ç–æ–≤
        const SYMBOLS = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£', 'üí∞', 'üö´'];
        
        // –í—ã–∏–≥—Ä—ã—à–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
        const PAYOUTS = {
            'üçí': 2,
            'üçã': 3,
            'üçä': 5,
            'üçá': 10,
            'üçâ': 20,
            '‚≠ê': 50,
            'üí∞': 100,
            '7Ô∏è‚É£': 200,
            'üö´': 0
        };
        
        // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã–∏–≥—Ä—ã—à–Ω—ã–µ –ª–∏–Ω–∏–∏ (–∏–Ω–¥–µ–∫—Å—ã —è—á–µ–µ–∫)
        const WIN_LINES = [
            [0, 1, 2],  // –≤–µ—Ä—Ö–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
            [3, 4, 5],  // —Å—Ä–µ–¥–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
            [6, 7, 8],  // –Ω–∏–∂–Ω—è—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å
            [0, 3, 6],  // –ª–µ–≤–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å
            [1, 4, 7],  // —Å—Ä–µ–¥–Ω—è—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å
            [2, 5, 8],  // –ø—Ä–∞–≤–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å
            [0, 4, 8],  // –¥–∏–∞–≥–æ–Ω–∞–ª—å —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
            [2, 4, 6]   // –¥–∏–∞–≥–æ–Ω–∞–ª—å —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ
        ];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü –Ω–∞ —Ñ–æ–Ω–µ
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = `${Math.random() * 10 + 5}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = `rgba(123, 44, 191, ${Math.random() * 0.5 + 0.2})`;
                particle.style.borderRadius = '50%';
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.left = `${Math.random() * 100}%`;
                
                const duration = Math.random() * 30 + 20;
                const delay = Math.random() * 10;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                particlesContainer.appendChild(particle);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initUser() {
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
                    const user = Telegram.WebApp.initDataUnsafe.user;
                    currentUserId = user.id.toString();
                } else {
                    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω–µ –≤ Telegram WebApp
                    currentUserId = new URLSearchParams(window.location.search).get('user_id') || 'test_user';
                }
                
                return currentUserId;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                throw error;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData(userId) {
            try {
                const userRef = database.ref('users/' + userId);
                
                userRef.on('value', (snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        userBalance = userData.balance || 0;
                        userBonusBalance = userData.bonus_balance || 0;
                        
                        document.getElementById('user-balance').textContent = `${userBalance} ‚≠ê`;
                        document.getElementById('user-bonus-balance').textContent = `${userBonusBalance} ‚≠ê`;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏
                        const canSpin = (userBonusBalance + userBalance) >= BET_AMOUNT;
                        document.getElementById('spin-btn').disabled = !canSpin || isSpinning;
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('game-content').style.display = 'block';
                    }
                });
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                throw error;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è 3x3
        function initSlotsGrid() {
            const grid = document.getElementById('slots-grid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'slot-cell';
                cell.id = `cell-${i}`;
                cell.textContent = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                grid.appendChild(cell);
            }
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
        async function spinAnimation() {
            const cells = document.querySelectorAll('.slot-cell');
            const spinDuration = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
            const steps = 10; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
            const delay = spinDuration / steps;
            
            for (let step = 0; step < steps; step++) {
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // –ú–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª—ã –≤ –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ
                cells.forEach(cell => {
                    const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
                    cell.textContent = SYMBOLS[randomIndex];
                    cell.classList.remove('win'); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏
                });
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
        function checkWin(results) {
            const winLines = [];
            let totalWin = 0;
            let blockSymbolsCount = 0;
            
            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            results.forEach(symbol => {
                if (symbol === 'üö´') blockSymbolsCount++;
            });
            
            // –ï—Å–ª–∏ 2 –∏–ª–∏ –±–æ–ª–µ–µ üö´ - –∞–Ω–Ω—É–ª–∏—Ä—É–µ–º –≤—ã–∏–≥—Ä—ã—à
            const isBlocked = blockSymbolsCount >= 2;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤—ã–∏–≥—Ä—ã—à–Ω—ã–µ –ª–∏–Ω–∏–∏
            WIN_LINES.forEach(line => {
                const [a, b, c] = line;
                if (results[a] === results[b] && results[b] === results[c]) {
                    const winAmount = BET_AMOUNT * PAYOUTS[results[a]];
                    const finalWin = useBonusBalance ? Math.floor(winAmount / 2) : winAmount;
                    
                    winLines.push({
                        line: line,
                        symbol: results[a],
                        multiplier: PAYOUTS[results[a]],
                        win: finalWin
                    });
                    
                    if (!isBlocked) {
                        totalWin += finalWin;
                    }
                }
            });
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à–Ω—ã–µ –ª–∏–Ω–∏–∏
            if (winLines.length > 0 && !isBlocked) {
                winLines.forEach(winLine => {
                    winLine.line.forEach(cellIndex => {
                        document.getElementById(`cell-${cellIndex}`).classList.add('win');
                    });
                });
                
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    document.querySelectorAll('.slot-cell').forEach(cell => {
                        cell.classList.remove('win');
                    });
                }, 5000);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                showResult(totalWin, winLines, isBlocked);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å, –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–∏–≥—Ä—ã—à
                if (totalWin > 0) {
                    database.ref('users/' + currentUserId).transaction((user) => {
                        if (user) {
                            user.balance = (user.balance || 0) + totalWin;
                        }
                        return user;
                    });
                }
            }, 1000);
        }
        
        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function showResult(totalWin, winLines, isBlocked = false) {
            const resultTitle = document.getElementById('result-title');
            const resultText = document.getElementById('result-text');
            const resultAmount = document.getElementById('result-amount');
            const winLinesElement = document.getElementById('win-lines');
            
            if (isBlocked) {
                resultTitle.textContent = '–í—ã–∏–≥—Ä—ã—à –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω';
                resultText.textContent = '–ù–∞–π–¥–µ–Ω–æ 2 –∏–ª–∏ –±–æ–ª–µ–µ —Å–∏–º–≤–æ–ª–æ–≤ üö´';
                resultAmount.textContent = '0 ‚≠ê';
                winLinesElement.textContent = '';
            } else if (winLines.length > 0) {
                resultTitle.textContent = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!';
                resultText.textContent = '–í–∞—à –≤—ã–∏–≥—Ä—ã—à:';
                resultAmount.textContent = `${totalWin} ‚≠ê`;
                
                let linesText = '';
                winLines.forEach((line, index) => {
                    linesText += `${line.symbol} x${line.multiplier} = ${line.win}‚≠ê`;
                    if (index < winLines.length - 1) linesText += '<br>';
                });
                
                winLinesElement.innerHTML = linesText;
            } else {
                resultTitle.textContent = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑!';
                resultText.textContent = '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –Ω–µ—Ç';
                resultAmount.textContent = '0 ‚≠ê';
                winLinesElement.textContent = '';
            }
            
            document.getElementById('result-modal').style.display = 'flex';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ö—Ä—É—Ç–∏—Ç—å"
        async function handleSpin() {
            if (isSpinning) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
            const totalBalance = userBonusBalance + userBalance;
            if (totalBalance < BET_AMOUNT) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å –∫–∞–∫–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Å–ø–∏—Å—ã–≤–∞—Ç—å
            useBonusBalance = userBonusBalance >= BET_AMOUNT;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            document.getElementById('confirm-text').textContent = 
                `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É ${BET_AMOUNT} ‚≠ê?`;
            
            const bonusWarning = document.getElementById('bonus-warning');
            if (useBonusBalance) {
                bonusWarning.style.display = 'block';
            } else {
                bonusWarning.style.display = 'none';
            }
            
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        async function executeSpin() {
            isSpinning = true;
            document.getElementById('spin-btn').disabled = true;
            document.getElementById('confirm-modal').style.display = 'none';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—É–º–º—É —Å–ø–∏—Å–∞–Ω–∏—è
            let useBonus = Math.min(userBonusBalance, BET_AMOUNT);
            let useMain = BET_AMOUNT - useBonus;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const updates = {};
            if (useBonus > 0) {
                updates['bonus_balance'] = userBonusBalance - useBonus;
            }
            if (useMain > 0) {
                updates['balance'] = userBalance - useMain;
            }
            
            await database.ref('users/' + currentUserId).update(updates);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
            await spinAnimation();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const results = [];
            const cells = document.querySelectorAll('.slot-cell');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±—É–¥–µ—Ç –ª–∏ –≤—ã–∏–≥—Ä—ã—à –Ω–∞ –æ—Å–Ω–æ–≤–µ CHANCE_OF_WIN
            const willWin = Math.random() * 100 < CHANCE_OF_WIN;
            
            if (willWin) {
                // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º—É–º –æ–¥–Ω—É –≤—ã–∏–≥—Ä—ã—à–Ω—É—é –ª–∏–Ω–∏—é
                const winLine = WIN_LINES[Math.floor(Math.random() * WIN_LINES.length)];
                const winSymbol = SYMBOLS[Math.floor(Math.random() * (SYMBOLS.length - 1))]; // –ò—Å–∫–ª—é—á–∞–µ–º üö´
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–∏–≥—Ä—ã—à–Ω—É—é –ª–∏–Ω–∏—é
                winLine.forEach(index => {
                    results[index] = winSymbol;
                });
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —è—á–µ–π–∫–∏ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
                for (let i = 0; i < 9; i++) {
                    if (results[i] === undefined) {
                        // 10% —à–∞–Ω—Å –Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Å–∏–º–≤–æ–ª –≤ –Ω–µ–≤—ã–∏–≥—Ä—ã—à–Ω—ã—Ö –ª–∏–Ω–∏—è—Ö
                        results[i] = Math.random() < 0.1 ? 'üö´' : SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                    }
                }
            } else {
                // –í—Å–µ —è—á–µ–π–∫–∏ —Å–ª—É—á–∞–π–Ω—ã–µ
                for (let i = 0; i < 9; i++) {
                    // 5% —à–∞–Ω—Å –Ω–∞ –±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Å–∏–º–≤–æ–ª
                    results[i] = Math.random() < 0.05 ? 'üö´' : SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];
                }
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            results.forEach((symbol, index) => {
                cells[index].textContent = symbol;
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–∏–≥—Ä—ã—à
            checkWin(results);
            
            isSpinning = false;

            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞
            setTimeout(() => {
                const canSpin = (userBonusBalance + userBalance - BET_AMOUNT) >= BET_AMOUNT;
                document.getElementById('spin-btn').disabled = !canSpin;
            }, 1000);
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            document.getElementById('spin-btn').addEventListener('click', handleSpin);
            
            document.getElementById('back-btn').addEventListener('click', () => {
                window.location.href = `index.html?user_id=${currentUserId}`;
            });
            
            document.getElementById('confirm-spin').addEventListener('click', executeSpin);
            
            document.getElementById('cancel-spin').addEventListener('click', () => {
                document.getElementById('confirm-modal').style.display = 'none';
            });
            
            document.getElementById('close-result').addEventListener('click', () => {
                document.getElementById('result-modal').style.display = 'none';
            });
        }
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function initApp() {
            initParticles();
            initSlotsGrid();
            
            try {
                const userId = await initUser();
                await loadUserData(userId);
                setupEventListeners();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
